#!/bin/bash\n# How to Extract and Use Pubkeys & Amounts from Frontend\n\n## ============================================================\n## GETTING OWNER PUBKEY FROM WALLET\n## ============================================================\n\n# The frontend automatically retrieves the owner's public key\n# from the connected UniSat wallet via useUnisat hook.\n\n# In frontend/app/page.tsx:\nconst { address: ownerAddress, publicKey: ownerPubkey } = useUnisat()\n\n# This returns:\n# ownerAddress:  \"tb1pxxxxxxxxxx...\" (Bitcoin address)\n# ownerPubkey:   \"0102030405...1f20\" (32-byte hex, 64 chars)\n\n# Example:\n# ownerPubkey = \"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20\"\n\n\n## ============================================================\n## GETTING HEIR PUBKEY FROM FORM INPUT\n## ============================================================\n\n# The heir's public key is entered by the user in the form.\n# It must be exactly 64 hexadecimal characters (32 bytes).\n\n# In frontend/components/create-vault-form.tsx:\n// User enters nomineePubkey in form input\nconst nomineePubkey = formData.nomineePubkey\n// Format: must be 64 hex characters\n// Example: \"201f1e1d1c1b1a19181716151413121110080706050403020100\"\n\n# The frontend validates this with formatPublicKey():\nexport function formatPublicKey(pubkeyHex: string): string {\n  let cleaned = pubkeyHex.startsWith(\"0x\") ? pubkeyHex.slice(2) : pubkeyHex;\n  if (cleaned.length < 64) {\n    cleaned = cleaned.padStart(64, \"0\");\n  }\n  if (!/^[0-9a-fA-F]{64}$/.test(cleaned)) {\n    throw new Error(\"Invalid public key format. Must be 32 bytes (64 hex characters)\");\n  }\n  return cleaned.toLowerCase();\n}\n\n\n## ============================================================\n## GETTING AMOUNT FROM FORM INPUT\n## ============================================================\n\n# The user enters an amount in BTC in the vault creation form.\n# Frontend converts to satoshis automatically.\n\n# In frontend/components/create-vault-form.tsx:\nconst lockedAmount = \"1.5\"  // User input in BTC\n\n# Frontend converts to satoshis:\nimport { btcToSatoshis } from \"@/lib/deployment\"\n\nconst satoshis = btcToSatoshis(1.5)  // Returns: 150000000\n\n# Conversion formula:\n// BTC * 100,000,000 = Satoshis\n// 1.5 * 100,000,000 = 150,000,000\n\n\n## ============================================================\n## FULL VAULT DATA GENERATED BY FRONTEND\n## ============================================================\n\n# When user submits the form, all this data is collected:\n\nconst vaultData = {\n  // From wallet connection:\n  ownerAddress: \"tb1paa4c5c6c7c8c9cacbcccdcedcfcecedcccccccccccccccccccccccccccccc\",\n  ownerPubkey: \"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20\",\n  \n  // From form input:\n  nomineeAddress: \"tb1pbb5d6d7d8d9dbdcdbecbebecbddcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd\",\n  nomineePubkey: \"201f1e1d1c1b1a19181716151413121110080706050403020100\",\n  \n  // From form input (BTC):\n  lockedAmount: 1.5,\n  \n  // Converted to satoshis:\n  lockedAmountSatoshis: 150000000,\n  \n  // From form selection:\n  inactivityTimeout: \"1-year\",\n  \n  // Converted to blocks:\n  inactivityTimeoutBlocks: 104000,\n  \n  // From contract config:\n  appVerificationKey: \"c78f9360ba4bc547be980aeb7c55e799184b8a6171d267cc53e1a427cdef7337\",\n}\n\n\n## ============================================================\n## ENVIRONMENT VARIABLES GENERATED\n## ============================================================\n\n# Frontend generates these environment variables:\n\nexport APP_VK=\"c78f9360ba4bc547be980aeb7c55e799184b8a6171d267cc53e1a427cdef7337\"\nexport OWNER_PUBKEY=\"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20\"\nexport HEIR_PUBKEY=\"201f1e1d1c1b1a19181716151413121110080706050403020100\"\nexport HEIR_ADDRESS=\"tb1pbb5d6d7d8d9dbdcdbecbebecbddcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd\"\nexport VAULT_VALUE=\"150000000\"\nexport VAULT_AMOUNT_BTC=\"1.5\"\nexport TIMEOUT_BLOCKS=\"104000\"\nexport NETWORK=\"testnet\"\n\n\n## ============================================================\n## SPELL GENERATION\n## ============================================================\n\n# Frontend generates the Initialize spell with all data:\n\nimport { generateInitializeSpell } from \"@/lib/deployment\"\n\nconst spell = generateInitializeSpell(\n  config,  // VaultDeploymentConfig with all validated data\n  \"abc123...def456\",  // UTXO ID (from user)\n  0        // UTXO Index\n)\n\n# Result (YAML):\nversion: 1\n\ninputs:\n  - utxo: \"abc123...def456:0\"\n    amount: 150000000\n    charms:\n      - app: \"c78f9360ba4bc547be980aeb7c55e799184b8a6171d267cc53e1a427cdef7337\"\n        data:\n          action: Initialize\n          owner_pubkey: \"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20\"\n          heir_pubkey: \"201f1e1d1c1b1a19181716151413121110080706050403020100\"\n          timeout_blocks: 104000\n\noutputs:\n  - address: \"tb1pbb5d6d7d8d9dbdcdbecbebecbddcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd\"\n    value: 150000000\n    charms:\n      - app: \"c78f9360ba4bc547be980aeb7c55e799184b8a6171d267cc53e1a427cdef7337\"\n        data:\n          action: Initialize\n          owner_pubkey: \"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20\"\n          heir_pubkey: \"201f1e1d1c1b1a19181716151413121110080706050403020100\"\n          timeout_blocks: 104000\n\n\n## ============================================================\n## HOW TO USE IN DEPLOYMENT\n## ============================================================\n\n# Step 1: User gets UTXO from bitcoin-cli\nbitcoin-cli listunspent 0\n\n# Output example:\n[\n  {\n    \"txid\": \"abc123...def456\",\n    \"vout\": 0,\n    \"amount\": 1.6,\n    \"confirmations\": 10\n  }\n]\n\n# Step 2: Frontend generates spell with UTXO\nconst spell = generateInitializeSpell(config, \"abc123...def456\", 0)\n\n# Step 3: Deploy spell\nbash deploy-vault.sh\n\n# Or manually:\necho \"$spell\" > initialize.yaml\ncat initialize.yaml | envsubst | charms spell check --app-bins=$(charms app build) --mock\n\n\n## ============================================================\n## DATA VALIDATION IN FRONTEND\n## ============================================================\n\n# Frontend validates all data before submission:\n\nimport { validateVaultConfig } from \"@/lib/deployment\"\n\nconst { valid, errors } = validateVaultConfig(config)\n\nif (!valid) {\n  console.error(\"Validation errors:\")\n  errors.forEach(error => console.error(` - ${error}`))\n}\n\n# Validation checks:\n// ✅ Owner pubkey: 64 hex characters\n// ✅ Heir pubkey: 64 hex characters\n// ✅ Heir address: Valid Bitcoin address format\n// ✅ Amount: 0.001 to 21 BTC\n// ✅ Timeout: 26,000 to 520,000 blocks\n// ✅ Network: testnet, livenet, or signet\n\n\n## ============================================================\n## EXAMPLE: COMPLETE USER FLOW\n## ============================================================\n\n# 1. User connects wallet\n# Browser: \"Connect Wallet\" → UniSat → User approves\n# Frontend gets:\n#   ownerAddress: \"tb1paa4c5c6c7c8c9cacbcccdcedcfcecedcccccccccccccccccccccccccccccc\"\n#   ownerPubkey:  \"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20\"\n\n# 2. User fills vault form\n# - Heir Address: \"tb1pbb5d6d7d8d9dbdcdbecbebecbddcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd\"\n# - Heir Pubkey:  \"201f1e1d1c1b1a19181716151413121110080706050403020100\"\n# - Amount: 1.5 BTC\n# - Timeout: 1-year\n\n# 3. Frontend generates deployment data\n# - Validates all inputs\n# - Converts BTC to satoshis (1.5 → 150,000,000)\n# - Converts timeout to blocks (1-year → 104,000)\n# - Creates VaultDeploymentConfig object\n\n# 4. User gets UTXO from bitcoin-cli\n# bitcoin-cli listunspent 0\n# Result: abc123...def456:0\n\n# 5. Frontend generates spell\n# - Uses UTXO id, amount, and all contract data\n# - Creates Initialize YAML\n# - Shows deployment report\n\n# 6. User deploys\n# - Frontend provides spell to user\n# - User signs with UniSat\n# - User broadcasts to Bitcoin testnet\n# - Transaction confirmed\n\n# 7. Vault is active\n# - Frontend dashboard shows vault details\n# - Owner can send pulse (heartbeat)\n# - Heir can claim after timeout\n\n\n## ============================================================\n## KEY FUNCTIONS & THEIR INPUTS/OUTPUTS\n## ============================================================\n\n# useUnisat() - Get wallet data\nInput: None\nOutput: { address, publicKey, isConnected, network, isUnisatInstalled }\n\n# formatPublicKey(pubkeyHex) - Validate & format public key\nInput: \"0102...\" or \"0x0102...\" (any length)\nOutput: \"0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20\" (64 hex)\nThrows: Error if invalid format\n\n# btcToSatoshis(btc) - Convert BTC to satoshis\nInput: 1.5\nOutput: 150000000\n\n# generateDeploymentBundle(ownerPubkey, heirPubkey, heirAddress, amountBtc, timeoutKey)\nInput: All form data\nOutput: {\n  success: boolean,\n  errors: string[],\n  config: VaultDeploymentConfig,\n  envVars: object,\n  initSpell: string,\n  report: string\n}\n\n# generateInitializeSpell(config, utxoId, utxoIndex) - Create spell\nInput: config, \"txid\", 0\nOutput: YAML string for spell\n\n# generatePulseSpell(vaultUtxo, amount, heirAddress) - Heartbeat spell\nInput: \"vault_txid\", 1.5, \"address\"\nOutput: YAML string for spell\n\n# generateClaimSpell(vaultUtxo, amount, heirAddress) - Claim spell\nInput: \"vault_txid\", 1.5, \"address\"\nOutput: YAML string for spell\n\n\n## ============================================================\n## SUMMARY\n## ============================================================\n\n# Owner Pubkey: Retrieved from wallet via useUnisat()\n# Heir Pubkey: Entered by user in form (64 hex chars)\n# Amount: Entered by user in BTC, converted to satoshis\n# All data: Validated by frontend before use\n# Spells: Generated with all validated data\n# Ready: For deployment to Bitcoin\n\n# The frontend handles:\n# ✅ Wallet connection\n# ✅ Public key retrieval and formatting\n# ✅ Amount conversion (BTC ↔ Satoshis)\n# ✅ Data validation\n# ✅ Spell generation\n# ✅ Environment variable setup\n\n# User only needs to:\n# 1. Connect wallet\n# 2. Enter heir address and pubkey\n# 3. Select amount and timeout\n# 4. Provide UTXO ID\n# 5. Deploy!\n